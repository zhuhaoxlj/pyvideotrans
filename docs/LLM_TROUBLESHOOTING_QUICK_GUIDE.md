# LLM 流式传输故障排除快速指南

## 🚨 常见问题速查

### 问题 1: 卡在"正在发送 HTTP 请求"

#### 日志表现
```
🔄 正在发送 HTTP 请求...
[长时间无响应]
```

#### 原因
- ❌ 网络连接问题
- ❌ 防火墙阻止
- ❌ DNS 解析失败

#### 解决方案
```bash
# 1. 测试网络连接
ping api.siliconflow.cn

# 2. 测试 HTTPS 连接
curl -I https://api.siliconflow.cn

# 3. 检查代理设置
echo $http_proxy
echo $https_proxy
```

---

### 问题 2: HTTP 401 错误

#### 日志表现
```
❌ HTTP 错误: 401
📋 错误详情: {"error": {"message": "Invalid API key"}}
```

#### 原因
- ❌ API Key 错误
- ❌ API Key 过期

#### 解决方案
1. 检查 `.env` 文件中的 `SILICONFLOW_API_KEY`
2. 登录 SiliconFlow 官网重新生成 API Key
3. 确认 API Key 复制完整（没有多余空格）

---

### 问题 3: HTTP 404 错误

#### 日志表现
```
❌ HTTP 错误: 404
📋 错误详情: {"error": {"message": "Model not found"}}
```

#### 原因
- ❌ 模型名称错误
- ❌ 模型不存在

#### 解决方案
1. 检查模型名称：`deepseek-ai/DeepSeek-R1`
2. 确认模型在平台是否可用
3. 查看 [SiliconFlow 模型列表](https://siliconflow.cn/models)

---

### 问题 4: 请求超时

#### 日志表现
```
🔄 正在发送 HTTP 请求...
[等待 120 秒...]
❌ 请求超时！(120秒)
```

#### 原因
- ❌ 网络太慢
- ❌ 服务器无响应
- ❌ 防火墙延迟

#### 解决方案
1. 检查网络速度
2. 更换网络环境
3. 稍后重试
4. 联系服务商

---

### 问题 5: 收到响应但无数据

#### 日志表现
```
✅ 收到响应！(耗时: 1.23秒)
📊 HTTP 状态码: 200
🔄 开始读取流式数据...
💓 接收中... (已处理 0 行, 0 个数据块)
💓 接收中... (已处理 0 行, 0 个数据块)
```

#### 原因
- ❌ 响应头不是流式格式
- ❌ 模型不支持流式输出
- ❌ 服务器问题

#### 解决方案
1. 检查响应头中的 `content-type` 是否为 `text/event-stream`
2. 确认模型支持流式输出
3. 尝试关闭流式输出（修改代码 `'stream': False`）

---

### 问题 6: JSON 解析失败

#### 日志表现
```
⚠️  JSON 解析失败: data: invalid json...
```

#### 原因
- ❌ 响应格式错误
- ❌ 数据损坏

#### 解决方案
1. 查看完整的错误数据
2. 检查是否是临时问题
3. 重试请求

---

### 问题 7: 流式传输中断

#### 日志表现
```
💓 接收中... (已处理 50 行, 25 个数据块)
⚠️  流式传输异常: Connection reset by peer
```

#### 原因
- ❌ 网络中断
- ❌ 服务器断开连接

#### 解决方案
1. 检查网络稳定性
2. 重试请求
3. 考虑使用更稳定的网络

---

## 🔍 诊断步骤

### 步骤 1: 识别卡点
查看日志最后一条消息：

| 最后日志 | 卡点 | 章节 |
|----------|------|------|
| 🔄 正在发送 HTTP 请求... | 网络连接 | 问题 1 |
| ❌ HTTP 错误: 401 | API Key | 问题 2 |
| ❌ HTTP 错误: 404 | 模型名称 | 问题 3 |
| ❌ 请求超时 | 网络超时 | 问题 4 |
| 💓 接收中... (0 行) | 无数据 | 问题 5 |

### 步骤 2: 查看详细错误
检查日志中的 `📋 错误详情` 或 `📋 错误内容`

### 步骤 3: 应用解决方案
根据上面对应的问题编号，查看解决方案

---

## ⚡ 快速检查清单

处理前检查：

- [ ] 网络连接正常
- [ ] API Key 已配置
- [ ] API Key 有效
- [ ] 模型名称正确
- [ ] 有足够的 API 额度

---

## 📊 正常日志流程参考

```
⏳ 正在调用 LLM API，请稍候...
📡 LLM 响应流:
   🌐 连接到: https://api.siliconflow.cn/v1/chat/completions
   📦 模型: deepseek-ai/DeepSeek-R1
   📝 Prompt 长度: 2345 字符
   🔄 正在发送 HTTP 请求...              ← 应该在 1-3 秒内完成
   ✅ 收到响应！(耗时: 1.23秒)           ← 正常
   📊 HTTP 状态码: 200                    ← 正常
   📋 响应头: {'content-type': 'text/event-stream', ...}  ← 正常
   🔄 开始读取流式数据...                 ← 应该在 1 秒内看到下一条
   📥 收到第一行数据: data: {"id":...    ← 正常
   [流式输出开始...]                      ← 实时显示
   💓 接收中... (已处理 50 行, 25 个数据块)  ← 每 5 秒更新
   [继续流式输出...]
   🏁 流式传输完成！                      ← 正常结束
   📊 接收完成: 共 150 行, 75 个数据块, 68 个内容片段
```

---

## 🆘 紧急联系

### 问题反馈
1. 复制完整日志
2. 截图界面
3. 说明操作步骤
4. 联系开发团队

### 临时解决方案
如果 LLM 功能无法使用，可以：
1. 取消勾选"启用 LLM 智能断句优化"
2. 使用规则引擎断句（速度快但质量稍差）

---

## 💡 性能参考

### 正常耗时（3 分钟视频）

| 阶段 | 正常耗时 | 异常阈值 |
|------|----------|----------|
| 发送请求 | 1-3 秒 | >10 秒 |
| 收到响应 | 1-2 秒 | >5 秒 |
| 收到第一行数据 | <1 秒 | >3 秒 |
| LLM 总耗时 | 5-15 秒 | >30 秒 |

### 心跳日志参考

正常情况：每 5 秒行数应增加 20-50 行
```
💓 接收中... (已处理 50 行, 25 个数据块)   ← 5 秒
💓 接收中... (已处理 100 行, 50 个数据块)  ← 10 秒
💓 接收中... (已处理 150 行, 75 个数据块)  ← 15 秒
```

异常情况：行数不增加或增加很慢
```
💓 接收中... (已处理 10 行, 5 个数据块)   ← 5 秒
💓 接收中... (已处理 12 行, 6 个数据块)   ← 10 秒  ⚠️ 只增加了 2 行
💓 接收中... (已处理 15 行, 7 个数据块)   ← 15 秒  ⚠️ 只增加了 3 行
```

---

## 🎯 总结

遇到问题时：

1. **不要慌** - 查看日志最后一条消息
2. **定位问题** - 对照本指南找到对应问题
3. **应用方案** - 按照解决方案操作
4. **记录日志** - 保存完整日志用于分析
5. **寻求帮助** - 如果无法解决，联系支持

**大部分问题都可以通过日志快速定位和解决！** 🎉

---

**创建日期**: 2025-10-27  
**版本**: 1.0.0  
**状态**: ✅ 可用

