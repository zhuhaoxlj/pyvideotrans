# LLM å­—å¹•ç¿»è¯‘ä¼˜åŒ–æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

åœ¨ä½¿ç”¨ LLM è¿›è¡Œæ‰¹é‡å­—å¹•ç¿»è¯‘æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç¿»è¯‘é—æ¼**ï¼šLLM è·³è¿‡æŸäº›å¥å­ï¼Œå¯¼è‡´è¯‘æ–‡ä¸å®Œæ•´
2. **è¡Œæ•°ä¸åŒ¹é…**ï¼šè¿”å›çš„ç¿»è¯‘æ•°é‡ä¸åŸæ–‡ä¸ä¸€è‡´
3. **æ ¼å¼é—®é¢˜**ï¼šLLM æ·»åŠ åºå·ã€æ³¨é‡Šç­‰é¢å¤–å†…å®¹
4. **è§£æé”™è¯¯**ï¼šç®€å•çš„å­—ç¬¦ä¸²åˆ†å‰²æ— æ³•æ­£ç¡®å¤„ç†å¤æ‚æƒ…å†µ

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ä¼˜åŒ– Prompt

**æ”¹è¿›å‰ï¼š**
```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­—å¹•ç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹å­—å¹•ç¿»è¯‘æˆä¸­æ–‡ã€‚
è¦æ±‚ï¼š...
```

**æ”¹è¿›åï¼š**
```
ä½ æ˜¯ä¸“ä¸šå­—å¹•ç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹10æ¡è‹±è¯­å­—å¹•ç¿»è¯‘æˆä¸­æ–‡ã€‚

âš ï¸ å…³é”®è¦æ±‚ï¼š
1. å¿…é¡»ç¿»è¯‘å…¨éƒ¨10æ¡å­—å¹•ï¼Œä¸€æ¡éƒ½ä¸èƒ½é—æ¼
2. ä¸¥æ ¼æŒ‰ç…§åŸæ–‡é¡ºåºè¾“å‡ºï¼Œæ¯è¡Œä¸€æ¡ç¿»è¯‘
3. æ¯æ¡å­—å¹•éƒ½å¿…é¡»æœ‰å¯¹åº”çš„ç¿»è¯‘ï¼Œä¸èƒ½è·³è¿‡
4. ä¸è¦æ·»åŠ åºå·ï¼ˆå¦‚1. 2.ï¼‰ã€æ³¨é‡Šæˆ–ä»»ä½•é¢å¤–å†…å®¹
5. ç¿»è¯‘è¦å‡†ç¡®ã€æµç•…ã€ç¬¦åˆä¸­æ–‡ä¹ æƒ¯

åŸæ–‡å­—å¹•ï¼ˆå…±10æ¡ï¼‰ï¼š
[åŸæ–‡å†…å®¹]

è¯·ç›´æ¥è¾“å‡º10æ¡ç¿»è¯‘ç»“æœï¼Œæ¯è¡Œä¸€æ¡ï¼Œç¡®ä¿æ•°é‡å®Œå…¨åŒ¹é…ï¼š
```

**æ”¹è¿›ç‚¹ï¼š**
- âœ… æ˜ç¡®å‘ŠçŸ¥å­—å¹•æ•°é‡ï¼ˆ"å…±10æ¡"ï¼‰
- âœ… ä½¿ç”¨ âš ï¸ ç¬¦å·å¼ºè°ƒå…³é”®è¦æ±‚
- âœ… å¤šæ¬¡å¼ºè°ƒ"ä¸èƒ½é—æ¼"ã€"å¿…é¡»ç¿»è¯‘å…¨éƒ¨"
- âœ… åœ¨ system message ä¸­å†æ¬¡å¼ºè°ƒè¾“å‡ºæ ¼å¼
- âœ… æé†’ä¸è¦æ·»åŠ åºå·å’Œæ³¨é‡Š

### 2. æ”¹è¿›è§£æé€»è¾‘

**æ”¹è¿›å‰ï¼š**
```python
translated_lines = result.split('\n')
translated_lines = [line.strip() for line in translated_lines if line.strip()]
```
âŒ é—®é¢˜ï¼šè¿‡æ»¤æ‰æ‰€æœ‰ç©ºè¡Œï¼Œå¯¼è‡´è¡Œæ•°å¯¹ä¸ä¸Š

**æ”¹è¿›åï¼š**
```python
import re

# åˆ†å‰²è¡Œ
lines = result.split('\n')

# ç§»é™¤åºå·å‰ç¼€ï¼ˆå¦‚ "1. ", "1) ", "1ã€"ï¼‰
translated_lines = []
for line in lines:
    cleaned = re.sub(r'^\d+[\.\)ã€]\s*', '', line).strip()
    translated_lines.append(cleaned)

# åªè¿‡æ»¤å¼€å¤´å’Œç»“å°¾çš„ç©ºè¡Œ
while translated_lines and not translated_lines[0]:
    translated_lines.pop(0)
while translated_lines and not translated_lines[-1]:
    translated_lines.pop()
```
âœ… æ”¹è¿›ï¼šä¿ç•™ä¸­é—´çš„è¡Œç»“æ„ï¼Œåªæ¸…ç†é¦–å°¾ç©ºè¡Œ

### 3. æ·»åŠ é‡è¯•æœºåˆ¶

```python
def translate_with_openai(self, translator, texts):
    """ä½¿ç”¨ OpenAI API ç¿»è¯‘ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰"""
    max_retries = 2
    
    for attempt in range(max_retries):
        try:
            result = self._translate_with_openai_once(translator, texts, attempt)
            
            # éªŒè¯ç»“æœå®Œæ•´æ€§
            missing_count = sum(1 for t in result if not t or not t.strip())
            
            if missing_count == 0:
                return result  # ç¿»è¯‘å®Œæ•´ï¼Œç›´æ¥è¿”å›
            
            elif attempt < max_retries - 1:
                # æœ‰é—æ¼ä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œè¡¥å……ç¿»è¯‘
                config.logger.warning(f'ç¬¬ {attempt + 1} æ¬¡ç¿»è¯‘æœ‰ {missing_count} æ¡é—æ¼ï¼Œå°è¯•è¡¥å……')
                result = self._fix_missing_translations(translator, texts, result)
                
                if sum(1 for t in result if not t or not t.strip()) == 0:
                    return result  # è¡¥å……åå®Œæ•´äº†
        
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            config.logger.warning(f'ç¬¬ {attempt + 1} æ¬¡ç¿»è¯‘å¤±è´¥ï¼Œé‡è¯•ä¸­: {e}')
    
    return result
```

### 4. æ™ºèƒ½è¡¥å……ç¿»è¯‘

å¯¹äºç¬¬ä¸€æ¬¡ç¿»è¯‘åä»æœ‰é—æ¼çš„å¥å­ï¼Œå•ç‹¬è¿›è¡Œè¡¥å……ç¿»è¯‘ï¼š

```python
def _fix_missing_translations(self, translator, original_texts, translated_texts):
    """è¡¥å……ç¿»è¯‘é—æ¼çš„å¥å­"""
    # æ‰¾å‡ºæ‰€æœ‰é—æ¼çš„ç´¢å¼•
    missing_indices = [i for i, t in enumerate(translated_texts) if not t or not t.strip()]
    
    if not missing_indices:
        return translated_texts
    
    # åªç¿»è¯‘é—æ¼çš„éƒ¨åˆ†
    texts_to_retry = [original_texts[i] for i in missing_indices]
    retried_translations = self._translate_with_openai_once(translator, texts_to_retry, attempt=99)
    
    # å¡«å……å›ç»“æœ
    result = list(translated_texts)
    for idx, translated in zip(missing_indices, retried_translations):
        if translated and translated.strip():
            result[idx] = translated
    
    return result
```

## ä¼˜åŒ–æ•ˆæœ

### æ”¹è¿›å‰
- âŒ 10æ¡å­—å¹•ä¸­å¯èƒ½æœ‰2-3æ¡é—æ¼
- âŒ LLM æœ‰æ—¶ä¼šæ·»åŠ åºå·ï¼š"1. è¯‘æ–‡"
- âŒ è¡Œæ•°å¯¹ä¸ä¸Šï¼Œå¯¼è‡´å­—å¹•é”™ä½
- âŒ æ²¡æœ‰éªŒè¯æœºåˆ¶

### æ”¹è¿›å
- âœ… è‡ªåŠ¨æ£€æµ‹é—æ¼å¹¶é‡è¯•
- âœ… æ™ºèƒ½ç§»é™¤åºå·å‰ç¼€
- âœ… ä¿è¯è¡Œæ•°åŒ¹é…
- âœ… æœ€å¤šé‡è¯•2æ¬¡ + è¡¥å……ç¿»è¯‘
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

## æ—¥å¿—ç¤ºä¾‹

**æ­£å¸¸æƒ…å†µï¼š**
```
âœ… ç¬¬ 1/10 æ‰¹å®Œæˆ (10%)
âœ… ç¬¬ 2/10 æ‰¹å®Œæˆ (20%)
...
âœ… ç¿»è¯‘å®Œæˆï¼
```

**æœ‰é—æ¼æƒ…å†µï¼š**
```
âš ï¸ ç¬¬ 1 æ¬¡ç¿»è¯‘æœ‰ 3 æ¡é—æ¼ï¼Œå°è¯•è¡¥å……ç¿»è¯‘
âœ… è¡¥å……ç¿»è¯‘å®Œæˆï¼Œç¬¬ 1/10 æ‰¹å®Œæˆ (10%)
```

**ç»“æœä¸è¶³æƒ…å†µï¼š**
```
âš ï¸ ç¿»è¯‘ç»“æœä¸è¶³ï¼šæœŸæœ› 10 æ¡ï¼Œå®é™… 8 æ¡
âš ï¸ ç¬¬ 1 æ¬¡ç¿»è¯‘æœ‰ 2 æ¡é—æ¼ï¼Œé‡è¯•ä¸­
âœ… ç¬¬ 2 æ¬¡ç¿»è¯‘å®Œæˆï¼Œç¬¬ 1/10 æ‰¹å®Œæˆ (10%)
```

## æœ€ä½³å®è·µå»ºè®®

### 1. æ‰¹æ¬¡å¤§å°è®¾ç½®

- **å°æ‰¹æ¬¡ï¼ˆ5-10æ¡ï¼‰**ï¼šæ›´å‡†ç¡®ï¼Œé—æ¼ç‡ä½ï¼Œä½†è€—æ—¶é•¿
- **ä¸­æ‰¹æ¬¡ï¼ˆ10-20æ¡ï¼‰**ï¼šå¹³è¡¡å‡†ç¡®æ€§å’Œæ•ˆç‡ï¼ˆæ¨èï¼‰
- **å¤§æ‰¹æ¬¡ï¼ˆ20-50æ¡ï¼‰**ï¼šé€Ÿåº¦å¿«ï¼Œä½†é—æ¼ç‡å¯èƒ½å¢åŠ 

### 2. æ¨¡å‹é€‰æ‹©

- **GPT-4o**ï¼šç¿»è¯‘è´¨é‡æœ€å¥½ï¼Œé—æ¼ç‡æœ€ä½ï¼ˆæ¨èï¼‰
- **GPT-4o-mini**ï¼šé€Ÿåº¦å¿«ï¼Œæ€§ä»·æ¯”é«˜
- **Claude 3.5 Sonnet**ï¼šç¿»è¯‘è´¨é‡ä¼˜ç§€ï¼Œä¸Šä¸‹æ–‡ç†è§£å¥½
- **DeepSeek**ï¼šä¸­æ–‡ç¿»è¯‘è´¨é‡å¥½ï¼Œä»·æ ¼ä¾¿å®œ

### 3. æ¸©åº¦è®¾ç½®

å½“å‰è®¾ç½®ï¼š`temperature=0.3`
- è¾ƒä½çš„æ¸©åº¦ä¿è¯ç¿»è¯‘çš„ä¸€è‡´æ€§å’Œç¨³å®šæ€§
- å‡å°‘éšæœºæ€§ï¼Œé™ä½é—æ¼æ¦‚ç‡

### 4. ç‰¹æ®Šæƒ…å†µå¤„ç†

**åŸæ–‡æœ¬èº«åŒ…å«ç©ºè¡Œï¼š**
- ç³»ç»Ÿä¼šä¿ç•™åŸæ–‡çš„è¡Œç»“æ„
- ç©ºè¡Œå¯¹åº”çš„è¯‘æ–‡ä¹Ÿä¼šæ˜¯ç©ºè¡Œ

**å¤šè¡Œå­—å¹•ï¼š**
- æ¯æ¡å­—å¹•ä½œä¸ºä¸€ä¸ªæ•´ä½“ç¿»è¯‘
- ç¿»è¯‘ç»“æœä¿æŒåŸæœ‰çš„æ¢è¡Œ

**ä¸“æœ‰åè¯ï¼š**
- Prompt å·²æ˜ç¡®è¦æ±‚ä¿ç•™ä¸“æœ‰åè¯
- LLM ä¼šæ™ºèƒ½è¯†åˆ«å¹¶ä¿ç•™

## æŠ€æœ¯ç»†èŠ‚

### åºå·è¯†åˆ«æ­£åˆ™è¡¨è¾¾å¼

```python
re.sub(r'^\d+[\.\)ã€]\s*', '', line)
```

å¯è¯†åˆ«å¹¶ç§»é™¤ï¼š
- `1. è¯‘æ–‡`
- `1) è¯‘æ–‡`
- `1ã€è¯‘æ–‡`
- `1 è¯‘æ–‡`

### éªŒè¯å®Œæ•´æ€§

```python
missing_count = sum(1 for t in result if not t or not t.strip())
```

æ£€æŸ¥ï¼š
- ç©ºå­—ç¬¦ä¸² `''`
- åªåŒ…å«ç©ºç™½å­—ç¬¦ `'  '`

## æœªæ¥å¯èƒ½çš„æ”¹è¿›

1. **JSON æ ¼å¼è¾“å‡º**ï¼šä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼Œå½»åº•è§£å†³æ ¼å¼é—®é¢˜
2. **Few-shot ç¤ºä¾‹**ï¼šåœ¨ prompt ä¸­æä¾›ç¤ºä¾‹ï¼Œæé«˜å‡†ç¡®æ€§
3. **æµå¼è¾“å‡º**ï¼šå®æ—¶æ˜¾ç¤ºç¿»è¯‘è¿›åº¦
4. **å¹¶è¡Œç¿»è¯‘**ï¼šå¤šæ‰¹æ¬¡å¹¶è¡Œå¤„ç†ï¼Œæé«˜é€Ÿåº¦
5. **ç¼“å­˜æœºåˆ¶**ï¼šç›¸åŒæ–‡æœ¬ä¸é‡å¤ç¿»è¯‘

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–ï¼ŒLLM å­—å¹•ç¿»è¯‘çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§å¾—åˆ°äº†æ˜¾è‘—æå‡ï¼š

- âœ… Prompt æ›´ä¸¥æ ¼ï¼Œæ˜ç¡®è¦æ±‚ä¸é—æ¼
- âœ… è§£æé€»è¾‘æ›´æ™ºèƒ½ï¼Œå¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
- âœ… é‡è¯•æœºåˆ¶ç¡®ä¿ç¿»è¯‘å®Œæ•´æ€§
- âœ… è¡¥å……ç¿»è¯‘é’ˆå¯¹æ€§è§£å†³é—æ¼é—®é¢˜
- âœ… è¯¦ç»†æ—¥å¿—å¸®åŠ©æ’æŸ¥é—®é¢˜

ç°åœ¨å¯ä»¥æ”¾å¿ƒä½¿ç”¨ LLM ç¿»è¯‘å¤§é‡å­—å¹•äº†ï¼ğŸ‰

