# 🔍 Whisper 词级时间戳检测工具

## 📖 工具说明

当字幕与视频实际时间不匹配时，这个工具可以帮助你精确定位问题根源：

- **如果是 Whisper 时间戳问题**：需要调整 Whisper 模型或参数
- **如果是 LLM 分割问题**：需要优化分词匹配算法

## ✨ 主要功能

### 1. 可视化词级时间戳
- 显示 Whisper 识别的所有单词
- 每个单词显示其精确时间戳
- 支持点击单词跳转播放

### 2. 精确时间验证
- 点击任意单词，视频自动跳转到该单词的时间戳位置
- 观察视频中实际说这个词的时间
- 对比时间戳是否准确

### 3. 详细信息展示
- 单词的开始时间
- 单词的结束时间
- 单词的持续时长
- 单词在整个文本中的位置

## 🚀 使用方法

### 启动工具

```bash
# 方法 1：使用启动脚本
./check_whisper_timestamp.sh

# 方法 2：直接运行
python whisper_timestamp_checker.py
```

### 操作步骤

1. **选择视频文件**
   - 点击"📁 选择视频文件"按钮
   - 选择你已经用 LLM 智能字幕生成工具处理过的视频
   - 工具会自动查找对应的 Whisper 缓存

2. **浏览单词列表**
   - 右侧显示所有识别的单词
   - 每个按钮显示：单词 + 时间戳

3. **点击测试**
   - 点击任意单词按钮
   - 视频自动跳转到该时间戳并播放
   - 观察视频中说这个词的实际时间

4. **验证准确性**
   - 如果视频画面和时间戳匹配 ✅ → Whisper 时间戳准确
   - 如果视频画面和时间戳不匹配 ❌ → Whisper 时间戳有偏差

## 📊 界面说明

### 左侧 - 视频播放器
- **视频画面**：显示视频内容
- **播放控制**：播放/暂停按钮
- **进度条**：显示当前播放位置
- **当前单词信息**：显示点击单词的详细信息

### 右侧 - 单词列表
- **统计信息**：显示总单词数和识别语言
- **单词按钮**：每个单词一个按钮
  - 第一行：单词文本
  - 第二行：时间戳（格式：分:秒.毫秒）
  - 悬停提示：显示完整信息（开始、结束、持续时间）

### 底部 - 状态栏
- 显示当前操作状态
- 播放提示信息

## 🔧 使用场景

### 场景 1：字幕时间不准确
**问题**：生成的字幕时间与视频不匹配

**检测步骤**：
1. 打开检测工具，加载视频
2. 找到有问题的那段字幕对应的单词
3. 点击该单词，观察视频跳转位置
4. 判断问题来源：
   - Whisper 时间戳就错了 → 问题在 Whisper
   - Whisper 时间戳对的，但字幕时间不对 → 问题在 LLM 分割或匹配算法

### 场景 2：某个单词一直对不上
**问题**：某个特定单词的时间总是错的

**检测步骤**：
1. 在单词列表中找到该单词
2. 点击该单词
3. 查看详细信息：
   - 持续时长是否异常（过长/过短）
   - 时间戳位置是否偏移
4. 对比相邻单词的时间戳，找出异常模式

### 场景 3：批量验证
**问题**：想快速检查整个视频的时间戳质量

**检测步骤**：
1. 随机点击不同位置的单词
2. 快速验证时间戳准确性
3. 找出有问题的时间段
4. 针对性优化

## 📝 实际案例分析

### 你的问题

```
字幕显示：
00:01:26,260 --> 00:01:31,040
are where we are.

实际播放：
01:27 时才读到 "are"
```

### 使用检测工具验证

1. **加载视频**
   - 选择 `How parades can build community _ Chantelle Rytter _ TEDxAtlanta.mp4`

2. **找到对应单词**
   - 在单词列表中找到 "are"（第一个）
   - 应该在 01:26.260 附近

3. **点击 "are"**
   - 查看视频是否跳转到 01:26.260
   - 观察画面中说 "are" 的实际时间

4. **对比分析**
   - 如果 Whisper 显示 "are" 在 01:26.260，但实际视频在 01:27 才说到
   - 说明 Whisper 的时间戳提前了 0.74 秒
   - **结论**：这是 Whisper 时间戳的问题

5. **进一步验证**
   - 点击 "are" 附近的其他单词
   - 检查整个句子的时间戳是否都有偏移
   - 确定是局部偏移还是整体偏移

## 🛠️ 技术细节

### 缓存位置
```
~/.pyvideotrans/whisper_cache/[video_hash].pkl
```

### 数据结构
```python
{
    'all_words': [
        {
            'word': 'are',
            'start': 86.26,    # 开始时间（秒）
            'end': 86.52,      # 结束时间（秒）
        },
        ...
    ],
    'language': 'en'
}
```

### 时间格式
- **显示格式**：`MM:SS.mmm`（分:秒.毫秒）
- **内部格式**：秒（浮点数）
- **精度**：毫秒级（3 位小数）

## 🎯 下一步优化

如果发现是 Whisper 时间戳问题，可以：

1. **调整 Whisper 参数**
   ```python
   # 在 faster-whisper 中调整
   model.transcribe(
       audio,
       word_timestamps=True,
       vad_filter=True,           # 启用 VAD 过滤
       vad_parameters=dict(
           threshold=0.5,          # 调整阈值
           min_silence_duration_ms=500
       )
   )
   ```

2. **使用更精确的模型**
   - 尝试 `large-v3` 而不是 `turbo`
   - 更大的模型通常时间戳更准确

3. **手动校准偏移**
   - 如果发现整体偏移（如都提前 0.7 秒）
   - 可以在代码中统一调整
   ```python
   TIMESTAMP_OFFSET = 0.7  # 秒
   word['start'] += TIMESTAMP_OFFSET
   word['end'] += TIMESTAMP_OFFSET
   ```

## ❓ 常见问题

### Q: 找不到缓存文件？
**A**: 需要先用 LLM 智能字幕生成工具处理该视频，生成 Whisper 缓存后才能使用本工具。

### Q: 视频播放不了？
**A**: 确保系统已安装必要的视频解码器，或将视频转换为 MP4 格式。

### Q: 单词太多，找不到目标单词？
**A**: 
1. 使用页面搜索功能（Ctrl+F / Cmd+F）
2. 根据时间估算位置（如 01:27 大约在 87 秒处）
3. 查看统计信息，计算大致位置

### Q: 时间戳格式不一样？
**A**: 工具内部统一使用秒（浮点数），显示时转换为易读格式。

## 📚 相关文档

- [Whisper 缓存功能说明](./WHISPER_CACHE_FEATURE.md)
- [LLM 智能分割说明](./LLM_SMART_SPLIT.md)
- [字幕处理工具说明](./字幕处理工具说明.md)

## 💡 使用建议

1. **定期验证**：处理新视频后，随机抽查几个单词，确保时间戳准确
2. **保存结果**：发现问题时，记录具体单词和偏移量，方便后续优化
3. **对比测试**：使用不同 Whisper 模型处理同一视频，对比时间戳准确性
4. **反馈改进**：如果发现普遍性问题，可以调整 Whisper 或 LLM 的参数

---

🎉 **现在就开始检测，找出字幕不准确的根本原因！**

