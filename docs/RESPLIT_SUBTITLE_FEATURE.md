# 字幕重新分割功能说明

## 功能概述

智能字幕工具新增了**字幕重新分割**功能，可以将从网上下载的长句字幕文件重新分割成短句，让字幕在视频上的显示更加美观。

## 使用场景

当你从网上下载的 `.srt` 字幕文件存在以下问题时：
- ✅ 每条字幕文本太长，渲染到视频上时显示多行
- ✅ 字幕换行不自然，影响视频观感
- ✅ 需要将长句拆分成更适合阅读的短句

## 工作原理

1. **读取原始字幕**：读取你提供的 `.srt` 字幕文件的文本内容
2. **词级时间戳识别**：使用 Faster-Whisper 对视频进行语音识别，获取精确到每个词的时间戳
3. **智能对齐**：将原始字幕文本与 Whisper 识别的词级时间戳进行智能对齐
4. **重新分割**：使用智能断句算法，基于以下规则重新分割字幕：
   - 句子边界（句号、问号、感叹号）
   - 从句分隔符（逗号、分号、冒号）
   - 最大持续时间限制
   - 最大词数限制
5. **生成新字幕**：输出重新分割后的字幕文件（`_resplit.srt`）

## 使用步骤

### 1. 打开智能字幕工具

在主界面中找到并打开 "AI智能字幕生成（词级时间戳）" 工具

### 2. 选择视频文件

点击 **"选择视频/音频"** 按钮，选择对应字幕的视频或音频文件

⚠️ **重要**：必须选择与字幕文件对应的视频文件，这样才能进行准确的词级时间戳识别

### 3. 启用字幕重新分割功能

勾选 **"🔄 使用现有字幕文件（重新智能分割长句）"** 选项

勾选后会显示字幕文件选择器

### 4. 选择字幕文件

点击 **"选择字幕文件(.srt)"** 按钮，选择你要重新分割的 `.srt` 字幕文件

### 5. 调整参数（可选）

- **语言**：选择字幕的语言（默认：英语）
- **模型**：选择 Whisper 模型大小（推荐：large-v3-turbo）
- **最大持续时间**：每条字幕的最大显示时间（默认：5秒）
- **最大词数**：每条字幕的最大词数（默认：15词）
- **加速设备**：选择 CPU 或 CUDA（如果有NVIDIA显卡）

### 6. 开始处理

点击 **"🎬 开始生成智能字幕"** 按钮

系统会：
1. 读取原始字幕文件
2. 使用 Whisper 识别视频语音（获取词级时间戳）
3. 对齐原始文本与识别结果
4. 智能重新分割字幕
5. 保存到 `SmartSplit` 目录

### 7. 查看结果

处理完成后：
- 重新分割的字幕会显示在预览区域
- 文件保存在 `SmartSplit` 目录中，文件名为 `原文件名_resplit.srt`
- 点击 **"📁 打开保存目录"** 查看结果文件

## 示例对比

### 原始字幕（网上下载）
```
1
00:00:00,000 --> 00:00:20,317
Transcriber: Phương Tú Lê Reviewer: Maxime Sobrier Bringing people together these days is a feat. Thousands of people coming joyfully together to create a mile long, beautiful,
```

### 重新分割后
```
1
00:00:00,000 --> 00:00:02,500
Transcriber: Phương Tú Lê Reviewer: Maxime Sobrier

2
00:00:02,500 --> 00:00:05,800
Bringing people together these days is a feat.

3
00:00:05,800 --> 00:00:10,200
Thousands of people coming joyfully together

4
00:00:10,200 --> 00:00:14,500
to create a mile long, beautiful,
```

## 技术特点

### 智能文本对齐
- 使用 SequenceMatcher 计算文本相似度
- 支持词级模糊匹配（相似度阈值 60%）
- 自动处理文本差异和识别错误

### 回退机制
- 如果原始字幕与识别结果相似度过低（<50%），自动使用 Whisper 识别的文本
- 如果词数差异过大（>30%），使用 Whisper 识别的结果
- 确保在任何情况下都能生成可用的字幕

### 智能断句算法
- **句子边界优先**：识别句号、问号、感叹号
- **从句分隔符次之**：识别逗号、分号、冒号
- **时长限制**：避免字幕显示时间过长
- **词数限制**：避免单条字幕文本过多
- **预判优化**：在接近限制时提前在合适的从句边界分割

## 注意事项

1. **视频文件必须对应**：选择的视频文件必须与字幕文件内容对应，否则对齐会失败
2. **处理时间较长**：需要运行 Whisper 模型进行语音识别，可能需要几分钟
3. **语言设置正确**：确保选择的语言与字幕内容一致
4. **文本相似度**：如果原始字幕与实际语音内容差异太大，可能无法准确对齐
5. **GPU加速**：如果有NVIDIA显卡，选择 CUDA 可以大幅提升处理速度

## 文件命名

- **新生成字幕**：`视频文件名_smart.srt`
- **重新分割字幕**：`视频文件名_resplit.srt`

## 常见问题

### Q: 对齐失败怎么办？
A: 系统会自动回退使用 Whisper 识别的文本。虽然可能与原始字幕有差异，但时间戳准确，可以正常使用。

### Q: 可以处理中文字幕吗？
A: 可以！支持中文、英文等多种语言。记得在语言选项中选择正确的语言。

### Q: 为什么需要视频文件？
A: 因为需要通过 Whisper 识别视频语音来获取词级时间戳，这是实现精确分割的关键。

### Q: 处理速度慢怎么办？
A: 
- 使用较小的模型（如 base 或 small）
- 使用 GPU 加速（CUDA）
- 处理较短的视频

### Q: 生成的字幕还是太长？
A: 可以调整参数：
- 减小"最大持续时间"（如 3秒）
- 减小"最大词数"（如 10词）

## 技术实现

本功能基于以下技术：
- **Faster-Whisper**：OpenAI Whisper 的高效实现，支持词级时间戳
- **SequenceMatcher**：Python difflib 库，用于文本相似度计算和对齐
- **智能断句算法**：考虑句子结构、标点符号、时长和词数的多维度算法

## 相关文档

- [SMART_SPLIT_IMPROVEMENTS.md](../SMART_SPLIT_IMPROVEMENTS.md) - 智能分割功能改进说明
- [QUICK_START.md](../QUICK_START.md) - 快速开始指南

