# ğŸ” æ·±åº¦è°ƒè¯•ï¼šæ—¶é—´æˆ³å¯¹é½é—®é¢˜

## ğŸ“Š å®é™…å¯¹æ¯”

### åŸå§‹å­—å¹•ï¼ˆWhisper ç›´æ¥ç”Ÿæˆï¼‰
```srt
124
00:08:00,920 --> 00:08:04,959   â† 4.039ç§’
We don't have to afford Kansas to get a year go down into the basement
```

### LLM é‡æ–°åˆ†å‰²å
```srt
129
00:08:00,920 --> 00:08:01,639   â† åªæœ‰0.719ç§’ï¼âŒ
We don't have to hoard cans and go down into the basement
```

**é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼æ’å€¼ä¼°ç®—æ²¡æœ‰ç”Ÿæ•ˆï¼**

---

## ğŸ” ä¸ºä»€ä¹ˆæ’å€¼æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

### å½“å‰æ’å€¼è§¦å‘æ¡ä»¶
```python
match_ratio = len(matched_indices) / len(text_words)
if match_ratio < 0.5:  # åªæœ‰åŒ¹é…ç‡ < 50% æ‰è§¦å‘
    # æ’å€¼ä¼°ç®—...
```

### å®é™…æƒ…å†µåˆ†æ

**LLM æ–‡æœ¬ï¼š** "We don't have to hoard cans and go down into the basement"ï¼ˆ10ä¸ªè¯ï¼‰

**Whisper è¯çº§æ—¶é—´æˆ³ï¼š**
```
[0] we (00:08:00.920 - 00:08:01.120)
[1] don't (00:08:01.120 - 00:08:01.340)
[2] have (00:08:01.340 - 00:08:01.520)
[3] to (00:08:01.520 - 00:08:01.639)
[4] afford (00:08:01.640 - 00:08:02.100)  â† é”™è¯¯è¯†åˆ«ï¼Œå®é™…æ˜¯ "hoard"
[5] Kansas (00:08:02.100 - 00:08:02.680)  â† é”™è¯¯è¯†åˆ«ï¼Œå®é™…æ˜¯ "cans"
[6] to (00:08:02.680 - 00:08:02.800)      â† é”™è¯¯è¯†åˆ«ï¼Œå®é™…æ˜¯ "and"
[7] get (00:08:02.800 - 00:08:03.000)
[8] a (00:08:03.000 - 00:08:03.100)
[9] year (00:08:03.100 - 00:08:03.400)
[10] go (00:08:03.400 - 00:08:03.600)
[11] down (00:08:03.600 - 00:08:03.900)
[12] into (00:08:03.900 - 00:08:04.100)
[13] the (00:08:04.100 - 00:08:04.300)
[14] basement (00:08:04.300 - 00:08:04.959)
```

**åŒ¹é…è¿‡ç¨‹ï¼š**
```python
"we"       â†’ åŒ¹é… words[0] âœ…
"don't"    â†’ åŒ¹é… words[1] âœ…
"have"     â†’ åŒ¹é… words[2] âœ…
"to"       â†’ åŒ¹é… words[3] âœ…
"hoard"    â†’ æœªæ‰¾åˆ°åŒ¹é…ï¼ˆafford ç›¸ä¼¼åº¦ä¸å¤Ÿï¼‰âŒ
"cans"     â†’ æœªæ‰¾åˆ°åŒ¹é…ï¼ˆKansas ç›¸ä¼¼åº¦ä¸å¤Ÿï¼‰âŒ
"and"      â†’ æœªæ‰¾åˆ°åŒ¹é…ï¼ˆto å·²è¢«ç”¨è¿‡ï¼‰âŒ
"go"       â†’ åŒ¹é… words[10] âœ… ï¼ˆè·³è¿‡äº†å¾ˆå¤šè¯ï¼‰
"down"     â†’ åŒ¹é… words[11] âœ…
"into"     â†’ åŒ¹é… words[12] âœ…
"the"      â†’ åŒ¹é… words[13] âœ…
"basement" â†’ åŒ¹é… words[14] âœ…
```

**ç»“æœï¼š**
- åŒ¹é…æ•°ï¼š8ä¸ª
- æ€»è¯æ•°ï¼š10ä¸ª
- åŒ¹é…ç‡ï¼š8/10 = 0.8 = **80%** âŒ
- **å› ä¸º > 50%ï¼Œæ’å€¼ä¼°ç®—æœªè§¦å‘ï¼**

**ä½†æ˜¯ï¼š**
- start = words[0].start = 00:08:00.920
- end = words[14].end = 00:08:04.959 âœ… **åº”è¯¥ç”¨è¿™ä¸ªï¼**
- **å®é™…å¾—åˆ°çš„ end = words[3].end = 00:08:01.639** âŒ

---

## ğŸ’¡ çœŸæ­£çš„é—®é¢˜

### é—®é¢˜ä¸åœ¨æ’å€¼ä¼°ç®—ï¼

é—®é¢˜åœ¨äºï¼š**åŒ¹é…ç®—æ³•çš„ word_idx æ²¡æœ‰æ­£ç¡®æ¨è¿›ï¼**

çœ‹ä»£ç ç¬¬876-877è¡Œï¼š
```python
if best_score > 0.5:
    matched_indices.append(best_match)
    word_idx = best_match + 1  # âš ï¸ é—®é¢˜åœ¨è¿™é‡Œï¼
    text_idx += 1
else:
    text_idx += 1  # åªæ¨è¿›text_idxï¼Œä¸æ¨è¿›word_idx
```

**é—®é¢˜åœºæ™¯ï¼š**
1. åŒ¹é…åˆ° words[3] "to" åï¼Œword_idx = 4
2. å°è¯•åŒ¹é… "hoard"ï¼Œåœ¨ words[4-18] èŒƒå›´å†…æ‰¾æœ€ä½³åŒ¹é…
3. æ‰¾ä¸åˆ°å¥½çš„åŒ¹é…ï¼ˆbest_score < 0.5ï¼‰
4. **text_idx += 1ï¼Œä½† word_idx è¿˜æ˜¯ 4ï¼**
5. ç»§ç»­å°è¯•åŒ¹é… "cans"ï¼Œè¿˜æ˜¯ä» words[4] å¼€å§‹æ‰¾
6. ...æŒç»­æ— æ³•æ¨è¿› word_idx
7. æœ€ç»ˆ `matched_indices = [0,1,2,3]`ï¼ŒåªåŒ¹é…äº†å‰4ä¸ªè¯ï¼

**æ‰€ä»¥æœ€åä¸€ä¸ªåŒ¹é…è¯æ˜¯ words[3]ï¼Œå…¶ end = 00:08:01.639ï¼**

---

## ğŸ”§ æ­£ç¡®çš„ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜æ ¹æº
å½“æ‰¾ä¸åˆ°åŒ¹é…æ—¶ï¼Œåº”è¯¥æ¨è¿› word_idx æ¥è·³è¿‡å¯èƒ½çš„é”™è¯¯è¯ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœåœ¨åŸåœ°ã€‚

### è§£å†³æ–¹æ¡ˆ
```python
if best_score > 0.5:
    matched_indices.append(best_match)
    word_idx = best_match + 1
    text_idx += 1
else:
    # âœ… å…³é”®ä¿®å¤ï¼šå³ä½¿æ²¡åŒ¹é…ï¼Œä¹Ÿè¦é€‚å½“æ¨è¿› word_idx
    # é¿å…é™·å…¥æ— é™å¾ªç¯åœ¨åŒä¸€ä½ç½®
    text_idx += 1
    
    # å¦‚æœè¿ç»­å¤šæ¬¡æœªåŒ¹é…ï¼Œæ¨è¿› word_idx
    # æˆ–è€…ï¼šä½¿ç”¨æ›´æ™ºèƒ½çš„ç­–ç•¥
```

### æˆ–è€…æ›´å¥½çš„æ–¹æ¡ˆ

çœ‹åŸç‰ˆ fn_llm_split.py çš„å®ç°ï¼Œä»–ä»¬çš„åŒ¹é…ç®—æ³•æ›´åŠ å¥å£®ï¼š
1. ä½¿ç”¨æ›´å¤§çš„å‰ç»çª—å£ï¼ˆmax_lookahead = 15ï¼‰
2. è€ƒè™‘ä½ç½®åç§»ï¼ˆoffset penaltyï¼‰
3. **å³ä½¿æ²¡æœ‰å®Œç¾åŒ¹é…ï¼Œä¹Ÿä¼šé€‰æ‹©æœ€ä½³çš„é‚£ä¸ªï¼ˆå³ä½¿åˆ†æ•°ä¸é«˜ï¼‰**

---

## ğŸ¯ å¾…å®ç°çš„ä¿®å¤

éœ€è¦ä¿®æ”¹ `_match_text_to_words` æ–¹æ³•çš„åŒ¹é…é€»è¾‘ï¼š

### é€‰é¡¹1ï¼šå¼ºåˆ¶æ¨è¿› word_idx
```python
if best_score > 0.5:
    matched_indices.append(best_match)
    word_idx = best_match + 1
    text_idx += 1
else:
    text_idx += 1
    # å³ä½¿æ²¡åŒ¹é…ï¼Œä¹Ÿæ¨è¿› word_idx ä¸€ç‚¹
    if word_idx < len(words) - 1:
        word_idx += 1
```

### é€‰é¡¹2ï¼šé™ä½åŒ¹é…é˜ˆå€¼ï¼ˆæ›´çµæ´»ï¼‰
```python
# å¦‚æœåœ¨å‰ç»èŒƒå›´å†…æ‰¾åˆ°äº†æœ€ä½³åŒ¹é…ï¼ˆå³ä½¿åˆ†æ•°ä¸é«˜ï¼‰
if best_match is not None and best_score > 0.3:  # é™ä½é˜ˆå€¼
    matched_indices.append(best_match)
    word_idx = best_match + 1
    text_idx += 1
else:
    text_idx += 1
    if word_idx < len(words) - 1:
        word_idx += 1
```

### é€‰é¡¹3ï¼šå®Œå…¨é‡‡ç”¨åŸç‰ˆç®—æ³•
ç›´æ¥æŠŠ fn_llm_split.py çš„ `_match_text_to_words` å¤åˆ¶è¿‡æ¥ã€‚

---

## ğŸš¨ ç»“è®º

**ä¹‹å‰çš„ä¿®å¤æ–¹å‘é”™äº†ï¼**

- âŒ æ’å€¼ä¼°ç®—ä¸æ˜¯ä¸»è¦é—®é¢˜ï¼ˆè™½ç„¶ä¹Ÿéœ€è¦ï¼‰
- âœ… çœŸæ­£çš„é—®é¢˜ï¼šåŒ¹é…ç®—æ³•çš„ word_idx æ¨è¿›é€»è¾‘æœ‰é—®é¢˜
- âœ… å¯¼è‡´ï¼šåªåŒ¹é…äº†å‰å‡ ä¸ªè¯å°±åœæ­¢äº†
- âœ… ç»“æœï¼šend æ—¶é—´æˆ³ä½¿ç”¨äº†å¾ˆæ—©çš„è¯çš„ç»“æŸæ—¶é—´

éœ€è¦ä¿®å¤åŒ¹é…ç®—æ³•æœ¬èº«ï¼

