# 🎬 Whisper Auto Captions - 完整功能版

## ✨ 功能概览

已成功集成三大功能到一个项目中：

1. **🎙️ 生成字幕** - 使用 Whisper AI 从视频/音频生成字幕
2. **✂️ 智能分割字幕** - 使用 LLM 优化字幕断句
3. **🎥 渲染字幕到视频** - 将字幕烧录到视频文件中

## 🚀 快速开始

### 启动程序

```bash
cd /Users/mark/Downloads/pyvideotrans/get_srt_zimu
uv run python main.py
```

程序会显示主菜单，包含三个功能按钮。

## 📋 功能详解

### 1. 🎙️ 生成字幕

**功能说明**: 使用 OpenAI Whisper 模型从视频或音频文件自动生成字幕

**操作步骤**:
1. 点击"生成字幕"按钮
2. 选择媒体文件（支持拖放）
3. 选择 Whisper 模型（推荐 Large-v3-Turbo）
4. 选择音频语言
5. 点击 "Create" 开始生成

**支持格式**:
- 视频: MP4, MOV, AVI, MKV, FLV, WMV
- 音频: MP3, WAV, M4A, FLAC

**输出文件**:
- `~/Videos/pyvideotrans/[项目名].srt` - SRT 字幕文件
- `~/Videos/pyvideotrans/[项目名].fcpxml` - Final Cut Pro XML

**特点**:
- ✅ 自动检测视频帧率
- ✅ 支持 90+ 种语言
- ✅ GPU 加速（MPS/CUDA/CPU）
- ✅ 自动分割长视频（10分钟片段）
- ✅ 实时显示转录文本

### 2. ✂️ 智能分割字幕

**功能说明**: 使用大语言模型（LLM）对字幕进行智能断句优化，提升可读性

**操作步骤**:
1. 点击左侧"智能分割"按钮
2. 选择 SRT 字幕文件（或在生成字幕后自动跳转）
3. 选择 LLM 提供商（SiliconFlow/OpenAI/Claude/DeepSeek/Local）
4. 输入或保存 API Key
5. 选择具体模型
6. 预览字幕内容
7. 点击"开始智能分割"
8. 查看实时处理日志

**LLM 提供商支持**:
- **SiliconFlow** - 国内可用，推荐（支持 DeepSeek、Qwen 等）
- **OpenAI** - GPT-4、GPT-3.5 等
- **Claude** - Anthropic 的 Claude 系列
- **DeepSeek** - DeepSeek Chat/Reasoner
- **Local** - 本地模型（需自行部署 OpenAI 兼容接口）

**推荐模型**:
- `deepseek-ai/DeepSeek-V3` (SiliconFlow) - 最推荐，质量高速度快
- `gpt-4o` (OpenAI) - 质量极高但成本较高
- `deepseek-chat` (DeepSeek) - 性价比最高

**输出文件**:
- `[原文件名]_llm_split.srt` - 优化后的字幕文件

**特点**:
- ✅ 智能断句，符合自然语义
- ✅ 保持时间轴准确性
- ✅ 流式输出，实时查看进度
- ✅ API Key 本地加密保存
- ✅ 支持多种 LLM 提供商
- ✅ 完整的错误处理和日志

**注意事项**:
- 需要配置对应 LLM 的 API Key
- 建议先用短字幕测试效果
- 处理时间取决于字幕长度和模型速度
- API Key 加密保存在本地，安全可靠

### 3. 🎬 视频渲染字幕

**功能说明**: 将字幕烧录到视频中，支持音频合并和软硬字幕

**操作步骤**:
1. 点击左侧"视频渲染"按钮
2. 选择视频文件（必选）
3. 选择音频文件（可选，用于替换或合并音频）
4. 选择字幕文件（可选，SRT/ASS 格式）
5. 配置样式:
   - 字幕类型: 硬字幕（烧录）/ 软字幕（内嵌）
   - 字体大小: 小/中/大/特大
   - 位置: 底部/顶部/中间
   - 描边: 提高可读性
   - 是否合并音频
6. 点击"开始渲染"
7. 查看实时处理日志

**字幕类型**:
- **硬字幕（烧录）**: 
  - 永久嵌入画面，任何播放器都能看到
  - 支持自定义样式
  - 适合分享到社交平台
  - 渲染时间较长
  
- **软字幕（内嵌）**:
  - 作为独立轨道嵌入，播放器可选择开关
  - 处理速度快
  - 文件体积小
  - 样式由播放器控制

**字幕样式选项** (仅硬字幕):
- **字体大小**: 
  - 小 (18px) - 适合高分辨率视频
  - 中 (24px) - 推荐，适合大部分场景
  - 大 (32px) - 易读性优先
  - 特大 (48px) - 演示/教学视频
  
- **位置**:
  - 底部 - 标准位置（推荐）
  - 顶部 - 避免遮挡画面底部
  - 中间 - 特殊需求

- **描边**: 添加描边和阴影，显著提升字幕可读性

**使用场景**:
1. **只烧录字幕**: 视频 + 字幕 → 带字幕的视频
2. **合并音频和字幕**: 视频 + 音频 + 字幕 → 完整作品
3. **只合并音频**: 视频 + 音频 → 替换音频的视频
4. **软字幕**: 快速嵌入字幕轨道

**输出文件**:
- `[原视频名]_rendered.mp4` - 处理后的视频文件（可自定义文件名）

**特点**:
- ✅ 使用 FFmpeg 高质量处理
- ✅ 支持硬字幕和软字幕
- ✅ 支持音频合并
- ✅ 实时显示处理日志
- ✅ 自动处理音频时长
- ✅ 完整的错误处理
- ✅ 支持多种视频和音频格式

**依赖要求**:
- **FFmpeg**: 必须安装并添加到系统 PATH
  - macOS: `brew install ffmpeg`
  - Ubuntu: `sudo apt install ffmpeg`
  - Windows: 下载并配置环境变量

**性能参数**:
- 硬字幕: CRF=23, Preset=medium（质量/速度平衡）
- 软字幕: copy 模式（不重新编码，速度极快）
- 预计速度: 1080p 硬字幕约 1-2x 实时速度

**注意事项**:
- 硬字幕渲染需要时间，取决于视频长度和分辨率
- 软字幕处理速度快，推荐用于快速预览
- 音频合并会自动处理时长匹配
- 输出文件保存在视频源文件所在目录

## 🎯 完整工作流程示例

### 场景：为一个英文教学视频添加中文字幕

1. **生成英文字幕**
   ```
   生成字幕 → 选择视频 → 语言选 English → 生成
   得到: video.srt（英文字幕）
   ```

2. **翻译字幕**
   ```
   使用其他翻译工具将英文字幕翻译成中文
   得到: video_zh.srt（中文字幕）
   ```

3. **优化断句**
   ```
   智能分割字幕 → 选择 video_zh.srt → LLM 优化
   得到: video_zh_split.srt（优化后的中文字幕）
   ```

4. **渲染到视频**
   ```
   渲染字幕到视频 → 选择原视频 + video_zh_split.srt → 渲染
   得到: video_subtitled.mp4（带中文字幕的视频）
   ```

## 📁 项目结构

```
get_srt_zimu/
├── main.py                  # 程序入口
├── pyproject.toml           # uv 配置
├── requirements.txt         # 依赖列表
├── ui/                      # 界面模块
│   ├── main_window.py       # 主窗口（带菜单）
│   ├── home_view.py         # 生成字幕界面
│   ├── process_view.py      # 处理进度界面
│   ├── split_view.py        # 字幕分割界面 ✨ 新增
│   └── render_view.py       # 视频渲染界面 ✨ 新增
├── utils/                   # 工具模块
│   ├── whisper_processor.py # Whisper 处理器
│   ├── model_loader.py      # 模型加载器
│   ├── srt_utils.py         # SRT 工具
│   └── paths.py             # 路径管理
└── models/                  # 模型存储目录
```

## ⚙️ 环境要求

### 必需

- Python 3.9+
- PySide6 (Qt界面)
- PyTorch (MPS 支持)
- openai-whisper
- ffmpeg (系统安装)

### 推荐

- Apple Silicon Mac（最佳 MPS 性能）
- 16GB+ RAM
- 50GB+ 可用空间（用于模型）

## 🔧 安装依赖

```bash
cd get_srt_zimu

# 使用 uv（推荐）
uv sync

# 或使用 pip
pip install -r requirements.txt
```

## 💡 使用技巧

1. **首次使用**
   - 先用 Small 或 Base 模型测试
   - 模型会自动下载并缓存
   
2. **最佳性能**
   - 使用 Large-v3-Turbo 模型
   - 确保 MPS 可用（Apple Silicon）
   
3. **长视频处理**
   - 程序会自动分割成 10 分钟片段
   - 各片段并行处理
   
4. **字幕优化**
   - 先生成字幕，再用 LLM 优化断句
   - LLM 优化可显著提升可读性
   
5. **视频渲染**
   - 先预览字幕效果
   - 选择合适的字体大小和位置

## 🐛 故障排除

### 问题 1: MPS 不可用

**解决方案**: 
- 确保是 Apple Silicon Mac
- 更新到最新版 PyTorch
- 如果还是不行，程序会自动使用 CPU

### 问题 2: 模型下载失败

**解决方案**:
- 检查网络连接
- 手动下载模型到 `models/` 目录
- 使用国内镜像源

### 问题 3: FFmpeg 未找到

**解决方案**:
```bash
# macOS
brew install ffmpeg

# Ubuntu
sudo apt install ffmpeg
```

### 问题 4: LLM API 密钥配置

**解决方案**:
1. 在智能分割页面选择 LLM 提供商
2. 输入 API Key 并点击"保存 API Key"
3. API Key 会加密保存在本地
4. 推荐使用 SiliconFlow (国内可用) 或 DeepSeek (性价比高)

**获取 API Key**:
- SiliconFlow: https://siliconflow.cn
- OpenAI: https://platform.openai.com
- Anthropic: https://console.anthropic.com
- DeepSeek: https://platform.deepseek.com

## 🎨 界面预览

### 主界面（左右布局）
```
┌───────────────┬─────────────────────────────────────┐
│               │                                     │
│  🎬 Whisper   │                                     │
│  Auto         │                                     │
│  Captions     │                                     │
│               │         内容区域                    │
│  ───────────  │      （根据左侧选择显示）            │
│               │                                     │
│  📝 生成字幕  │   - 生成字幕页面                    │
│               │   - 智能分割页面                    │
│  ✂️ 智能分割  │   - 视频渲染页面                    │
│               │                                     │
│  🎬 视频渲染  │                                     │
│               │                                     │
│  v1.0.0       │                                     │
└───────────────┴─────────────────────────────────────┘
```

**特点**:
- 左侧固定导航栏，随时切换功能
- 右侧内容区域动态显示对应功能
- 处理过程中切换页面不会丢失状态
- 统一的现代化 UI 风格

## 📊 对比：合并前 vs 合并后

| 特性 | pyvideotrans | get_srt_zimu (原版) | get_srt_zimu (完整版) |
|------|-------------|---------------------|----------------------|
| 字幕生成 | ✅ | ✅ | ✅ |
| 智能分割 | ✅ | ❌ | ✅ 完整实现 |
| 视频渲染 | ✅ | ❌ | ✅ 完整实现 |
| 音频合并 | ✅ | ❌ | ✅ 新增 |
| 软硬字幕 | ⚠️ 部分支持 | ❌ | ✅ 全支持 |
| MPS 支持 | ⚠️ 有问题 | ✅ 正常 | ✅ 正常 |
| 依赖冲突 | ⚠️ 环境复杂 | ✅ 简洁 | ✅ 简洁 |
| 界面统一 | ❌ 多窗口 | ✅ 单窗口 | ✅ 单窗口左右布局 |
| 状态保持 | ❌ | ❌ | ✅ 切换页面不丢失进度 |
| 实时日志 | ⚠️ 部分支持 | ✅ | ✅ 全功能支持 |

## 🎉 优势

1. **功能完整** - 三大核心功能全部完整实现
2. **统一环境** - 所有功能使用同一套依赖，无冲突
3. **MPS 稳定** - 基于稳定的 PyTorch 环境，Apple Silicon 完美支持
4. **界面现代** - 左右布局，导航清晰，操作流畅
5. **状态保持** - 处理过程中切换页面不会丢失进度
6. **实时反馈** - 所有功能都有实时日志和进度显示
7. **本地处理** - 所有数据本地处理，保护隐私
8. **易于扩展** - 模块化设计，方便添加新功能

## 🌟 核心亮点

### 1. 完整的 LLM 智能分割
- 支持 5 种主流 LLM 提供商
- 流式输出，实时查看处理进度
- API Key 加密保存
- 完整的错误处理和重试机制

### 2. 专业的视频渲染
- 硬字幕和软字幕双模式
- 支持音频合并
- 多种样式自定义
- FFmpeg 高质量处理

### 3. 稳定的 Whisper 转录
- MPS 加速，速度快
- 自动分段处理长视频
- 支持 90+ 语言
- 实时显示转录文本

## 🔮 后续计划

- [x] 实现 LLM API 集成（字幕分割）✅
- [x] 实现 FFmpeg 集成（视频渲染）✅
- [x] 添加状态保持（页面切换不丢失进度）✅
- [ ] 添加字幕编辑功能
- [ ] 添加批量处理功能
- [ ] 添加视频预览功能
- [ ] 支持更多字幕格式
- [ ] 添加字幕样式预设

---

**现在可以测试了！** 🚀

```bash
cd /Users/mark/Downloads/pyvideotrans/get_srt_zimu
uv run python main.py
```

所有功能已经集成到一个统一的界面中！✨

