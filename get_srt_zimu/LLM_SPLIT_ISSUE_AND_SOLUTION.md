# LLM æ™ºèƒ½åˆ†å‰²é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰çŠ¶æ€

ä» `llm_output.txt` æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼š
- âœ… æˆåŠŸåŒ¹é…: 69/114 ä¸ª segments
- âŒ å¤±è´¥åŒ¹é…: 45/114 ä¸ª segments (39.5% å¤±è´¥ç‡)
- âš ï¸ åŸå› : `å½“å‰ word_idx: 1230/1230` - è¯å·²ç”¨å®Œï¼Œä½†è¿˜æœ‰æ–‡æœ¬æœªæ˜ å°„

### æ ¹æœ¬åŸå› 

**get_srt_zimu çš„å®ç°è¿‡äºç®€åŒ–**ï¼Œç¼ºå°‘ä¸»é¡¹ç›® `fn_llm_split.py` çš„å…³é”®åŠŸèƒ½ï¼š

1. âŒ **ç¼ºå°‘å¤æ‚çš„åºåˆ—å¯¹é½ç®—æ³•**
   - ä¸»é¡¹ç›®ä½¿ç”¨åŠ¨æ€è§„åˆ’åŒ¹é…
   - get_srt_zimu ä½¿ç”¨ç®€å•çš„ difflib åŒ¹é…

2. âŒ **ç¼ºå°‘ç¼–è¾‘è·ç¦»è®¡ç®—**
   - ä¸»é¡¹ç›®æœ‰ Levenshtein è·ç¦»ç®—æ³•
   - get_srt_zimu æ²¡æœ‰

3. âŒ **ç¼ºå°‘æ™ºèƒ½åŒ¹é…åˆ†æ•°**
   - ä¸»é¡¹ç›®è€ƒè™‘éƒ¨åˆ†åŒ¹é…ã€åŒ…å«å…³ç³»ç­‰
   - get_srt_zimu åªåšç²¾ç¡®åŒ¹é…

4. âŒ **ç¼ºå°‘æ—¶é—´æˆ³æ’å€¼ä¼°ç®—**
   - ä¸»é¡¹ç›®å¯å¤„ç† Whisper ç¼ºå¤±çš„è¯
   - get_srt_zimu æ— æ³•å¤„ç†

### æŠ€æœ¯å†²çª

**æ›´ä¸¥é‡çš„é—®é¢˜**ï¼š
- ä¸»é¡¹ç›®ä½¿ç”¨ **faster-whisper**
- ä½ è®©æˆ‘æ”¹æˆäº† **OpenAI Whisper**

è¿™å¯¼è‡´ä¸ä¸€è‡´ï¼

## ğŸ“Š ä»£ç å¯¹æ¯”

### ä¸»é¡¹ç›® (videotrans/winform/fn_llm_split.py)

| åŠŸèƒ½æ¨¡å— | è¡Œæ•° | è¯´æ˜ |
|---------|------|------|
| æ€»ä»£ç  | ~1977 è¡Œ | éå¸¸å®Œæ•´çš„å®ç° |
| `_match_text_to_words` | ~100 è¡Œ | å¤æ‚åºåˆ—å¯¹é½ |
| `_calculate_match_score` | ~30 è¡Œ | æ™ºèƒ½ç›¸ä¼¼åº¦ |
| `_levenshtein_distance` | ~20 è¡Œ | ç¼–è¾‘è·ç¦» |
| `_validate_and_adjust_timestamps` | ~30 è¡Œ | æ—¶é—´æˆ³è°ƒæ•´ |
| `fallback_split` | ~80 è¡Œ | è§„åˆ™å¼•æ“å›é€€ |
| **Whisperå¼•æ“** | **faster-whisper** | âœ… |

### get_srt_zimu (utils/llm_processor.py)

| åŠŸèƒ½æ¨¡å— | è¡Œæ•° | è¯´æ˜ |
|---------|------|------|
| æ€»ä»£ç  | ~1224 è¡Œ | ç®€åŒ–å®ç° |
| `_match_text_to_words` | âŒ æ—  | ä½¿ç”¨ difflib |
| `_calculate_match_score` | âŒ æ—  | æ—  |
| `_levenshtein_distance` | âŒ æ—  | æ—  |
| `_validate_and_adjust_timestamps` | âœ… æœ‰ | ç®€åŒ–ç‰ˆ |
| `fallback_split` | âœ… æœ‰ | ç®€åŒ–ç‰ˆ |
| **Whisperå¼•æ“** | **OpenAI Whisper** | âš ï¸ å†²çªï¼ |

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå®Œå…¨å¤åˆ¶ä¸»é¡¹ç›®é€»è¾‘ â­æ¨è

**åšæ³•**ï¼š
1. å°† **LLM åˆ†å‰²éƒ¨åˆ†** æ”¹å›ä½¿ç”¨ **faster-whisper**
2. å®Œæ•´å¤åˆ¶ä¸»é¡¹ç›®çš„æ‰€æœ‰ç®—æ³•ï¼š
   - `_match_text_to_words`
   - `_calculate_match_score`  
   - `_levenshtein_distance`
   - `_validate_and_adjust_timestamps`
   - `fallback_split`

**ä¼˜ç‚¹**ï¼š
- âœ… 100% ä¸ä¸»é¡¹ç›®ä¸€è‡´
- âœ… é«˜åŒ¹é…æˆåŠŸç‡
- âœ… ç¨³å®šå¯é 

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦åŒæ—¶å®‰è£… OpenAI Whisper å’Œ faster-whisper
- âš ï¸ ä»£ç é‡å¤§

**å®ç°æ–¹å¼**ï¼š
```python
# å­—å¹•ç”Ÿæˆï¼šä½¿ç”¨ OpenAI Whisper
from whisper import load_model

# LLM æ™ºèƒ½åˆ†å‰²ï¼šä½¿ç”¨ faster-whisper
from faster_whisper import WhisperModel
```

### æ–¹æ¡ˆ Bï¼šç»Ÿä¸€ä½¿ç”¨ faster-whisper

**åšæ³•**ï¼š
1. å°†**å­—å¹•ç”Ÿæˆ**ä¹Ÿæ”¹å› **faster-whisper**
2. å®Œæ•´å¤åˆ¶ä¸»é¡¹ç›®ä»£ç 

**ä¼˜ç‚¹**ï¼š
- âœ… 100% ä¸€è‡´æ€§
- âœ… åªéœ€ä¸€ä¸ª Whisper åº“
- âœ… æ€§èƒ½æ›´å¥½ï¼ˆfaster-whisper æ›´å¿«ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ æ”¾å¼ƒäº†ä¹‹å‰çš„ OpenAI Whisper æ”¹é€ 
- âŒ æ— æ³•ä½¿ç”¨ MPSï¼ˆApple Silicon GPUï¼‰

### æ–¹æ¡ˆ Cï¼šæ”¹è¿› get_srt_zimu çš„åŒ¹é…ç®—æ³•

**åšæ³•**ï¼š
1. ä¿æŒ OpenAI Whisper
2. æ·»åŠ ä¸»é¡¹ç›®çš„åŒ¹é…ç®—æ³•

**ä¼˜ç‚¹**ï¼š
- âœ… ä¿ç•™ OpenAI Whisper
- âœ… æ”¹è¿›åŒ¹é…æˆåŠŸç‡

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦å¤§é‡ä»£ç ç§»æ¤
- âš ï¸ å¯èƒ½ä»æœ‰ç»†èŠ‚ä¸ä¸€è‡´

## ğŸ¯ æ¨èè¡ŒåŠ¨

### æˆ‘çš„å»ºè®®ï¼šæ–¹æ¡ˆ Aï¼ˆæ··åˆä½¿ç”¨ï¼‰

#### ç†ç”±

1. **å­—å¹•ç”Ÿæˆ** ç”¨ OpenAI Whisper
   - ä½ å·²ç»æ”¹é€ å®Œæˆ
   - æ”¯æŒ Apple Siliconï¼ˆè™½ç„¶è¯çº§æ—¶é—´æˆ³è¦ç”¨ CPUï¼‰
   - å®˜æ–¹å®ç°ï¼Œæ›´æ–°åŠæ—¶

2. **LLM æ™ºèƒ½åˆ†å‰²** ç”¨ faster-whisper
   - ä¸»é¡¹ç›®å°±æ˜¯è¿™æ ·è®¾è®¡çš„
   - æ€§èƒ½æ›´å¥½ï¼ˆCPU æ¨¡å¼å°±å¾ˆå¿«ï¼‰
   - å®Œæ•´çš„åŒ¹é…ç®—æ³•å·²éªŒè¯

#### å®ç°æ­¥éª¤

1. **ä¿ç•™ `utils/whisper_processor.py`**
   - ä½¿ç”¨ OpenAI Whisper
   - ç”¨äºå­—å¹•ç”Ÿæˆ

2. **ä¿®æ”¹ `utils/llm_processor.py`**
   - å¯¼å…¥ faster-whisper
   - å®Œæ•´å¤åˆ¶ä¸»é¡¹ç›®çš„åŒ¹é…ç®—æ³•
   - æ·»åŠ æ‰€æœ‰è¾…åŠ©æ–¹æ³•

3. **å®‰è£…ä¸¤ä¸ªåº“**
   ```bash
   pip install openai-whisper>=20231117
   pip install faster-whisper>=0.10.0
   ```

## ğŸ“‹ éœ€è¦å¤åˆ¶çš„ä»£ç æ¸…å•

ä»ä¸»é¡¹ç›® `videotrans/winform/fn_llm_split.py` å¤åˆ¶åˆ° `get_srt_zimu/utils/llm_processor.py`ï¼š

### 1. æ ¸å¿ƒåŒ¹é…ç®—æ³• (å¿…éœ€)

```python
def _match_text_to_words(self, text, words, start_idx):
    """
    å¢å¼ºçš„æ–‡æœ¬åˆ°å•è¯æ—¶é—´æˆ³åŒ¹é…ç®—æ³•
    - æ”¯æŒç¼ºå¤±è¯å¤„ç†
    - æ—¶é—´æˆ³æ’å€¼ä¼°ç®—
    - æ™ºèƒ½åºåˆ—å¯¹é½
    """
    # ~100 è¡Œä»£ç 
```

### 2. ç›¸ä¼¼åº¦è®¡ç®— (å¿…éœ€)

```python
def _calculate_match_score(self, text_word, whisper_word):
    """è®¡ç®—ä¸¤ä¸ªè¯çš„åŒ¹é…åˆ†æ•° (0.0-1.0)"""
    # ~30 è¡Œä»£ç 

def _levenshtein_distance(self, s1, s2):
    """è®¡ç®—ç¼–è¾‘è·ç¦»"""
    # ~20 è¡Œä»£ç 
```

### 3. æ—¶é—´æˆ³éªŒè¯ (æ”¹è¿›)

```python
def _validate_and_adjust_timestamps(self, subtitles):
    """éªŒè¯å’Œè°ƒæ•´æ—¶é—´æˆ³"""
    # ~30 è¡Œä»£ç ï¼Œget_srt_zimu æœ‰ç®€åŒ–ç‰ˆï¼Œéœ€è¦æ›¿æ¢
```

### 4. å›é€€æœºåˆ¶ (æ”¹è¿›)

```python
def fallback_split(self, words):
    """å›é€€åˆ°è§„åˆ™å¼•æ“æ–­å¥ï¼ˆå½“LLMå¤±è´¥æ—¶ï¼‰"""
    # ~80 è¡Œä»£ç ï¼Œget_srt_zimu æœ‰ç®€åŒ–ç‰ˆï¼Œéœ€è¦æ›¿æ¢
```

### 5. faster-whisper é›†æˆ

```python
# åœ¨ run() æ–¹æ³•ä¸­
from faster_whisper import WhisperModel

model = WhisperModel(
    self.model_size,
    device=self.device,
    compute_type=compute_type,
    download_root=str(models_dir)
)
```

## ğŸš€ ä¸‹ä¸€æ­¥

### é€‰æ‹©æ–¹æ¡ˆ

è¯·å‘Šè¯‰æˆ‘ä½ å¸Œæœ›ï¼š

**é€‰é¡¹ 1**: æ–¹æ¡ˆ A - æ··åˆä½¿ç”¨ï¼ˆæ¨èï¼‰
  - å­—å¹•ç”Ÿæˆï¼šOpenAI Whisper
  - LLM åˆ†å‰²ï¼šfaster-whisper
  - éœ€è¦å¤åˆ¶ä¸»é¡¹ç›®ä»£ç 

**é€‰é¡¹ 2**: æ–¹æ¡ˆ B - å…¨éƒ¨ faster-whisper
  - å®Œå…¨å›é€€
  - 100% ä¸€è‡´æ€§
  - æ”¾å¼ƒä¹‹å‰çš„æ”¹é€ 

**é€‰é¡¹ 3**: æ–¹æ¡ˆ C - å…¨éƒ¨ OpenAI Whisper
  - ä¿ç•™ç°çŠ¶
  - åªå¤åˆ¶åŒ¹é…ç®—æ³•
  - å¯èƒ½æœ‰ç»†èŠ‚å·®å¼‚

### å¦‚æœé€‰æ‹©æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰

æˆ‘å°†ï¼š
1. ä¿®æ”¹ `utils/llm_processor.py`
2. æ·»åŠ  faster-whisper æ”¯æŒ
3. å®Œæ•´å¤åˆ¶æ‰€æœ‰åŒ¹é…ç®—æ³•
4. æ›´æ–° requirements.txt
5. æµ‹è¯•éªŒè¯

é¢„è®¡ä¿®æ”¹ï¼š
- æ–‡ä»¶æ•°ï¼š1 ä¸ª
- ä»£ç é‡ï¼š+300 è¡Œ
- æ—¶é—´ï¼š30 åˆ†é’Ÿ

## ğŸ“– å‚è€ƒ

- ä¸»é¡¹ç›®å®ç°ï¼š`videotrans/winform/fn_llm_split.py` (1977 è¡Œ)
- å½“å‰å®ç°ï¼š`get_srt_zimu/utils/llm_processor.py` (1224 è¡Œ)
- é—®é¢˜æ—¥å¿—ï¼š`get_srt_zimu/resource/llm_output.txt`

---

**ç­‰å¾…ä½ çš„é€‰æ‹©ï¼** ğŸ˜Š

