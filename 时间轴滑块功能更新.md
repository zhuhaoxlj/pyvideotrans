# 时间轴滑块功能更新 ✅

## 🎯 新增功能

在字幕预览功能的基础上，新增了**时间轴滑块**，现在您可以自由选择预览视频的任意时间点！

## 📋 功能说明

### 新增UI组件

在视频预览区域下方，添加了一个完整的时间轴控制条：

```
┌──────────────────────────────────────────────────┐
│        视频预览区域 (640×360)                     │
└──────────────────────────────────────────────────┘
┌─────────┬─────────────────────────────┬─────────┐
│00:00:00 │ ━━━━━━━━━◉━━━━━━━━━━━━━━━ │00:05:23 │
│当前时间 │      时间轴滑块              │总时长   │
└─────────┴─────────────────────────────┴─────────┘
         [ 刷新预览 ]
```

### 组件详情

1. **当前时间标签** (左侧)
   - 显示当前滑块位置对应的时间
   - 格式：HH:MM:SS
   - 实时更新

2. **时间轴滑块** (中间)
   - 横向拖动条，范围0-100%
   - 有刻度线，每10%一个刻度
   - 可以精确拖动到任意位置
   - 拖动时实时提取对应时间点的视频帧

3. **总时长标签** (右侧)
   - 显示视频的总时长
   - 格式：HH:MM:SS
   - 固定不变

## 🚀 使用方法

### 基本操作

1. **选择视频**
   - 点击"选择视频文件"按钮
   - 选择您要处理的视频
   - 系统会自动：
     * 加载视频信息
     * 显示视频总时长
     * 启用时间轴滑块
     * 默认定位到视频中间（50%）

2. **拖动时间轴**
   - 用鼠标左键拖动滑块
   - 或者点击滑块轨道上的任意位置
   - 系统会自动：
     * 更新当前时间显示
     * 提取对应时间点的视频帧
     * 在预览区域显示新的帧
     * 自动更新字幕预览效果

3. **精确定位**
   - 可以使用键盘方向键微调（如果滑块获得焦点）
   - 左/右方向键：向前/后移动1%
   - Page Up/Down：快速移动10%

### 使用场景示例

#### 场景1：预览视频开头的字幕效果
```
1. 选择视频文件
2. 拖动滑块到最左边（0%）
3. 调整字幕参数，查看字幕在开头的效果
```

#### 场景2：预览视频高潮部分
```
1. 选择视频文件
2. 根据您对视频的了解，拖动到相应位置（如70%）
3. 微调滑块找到最佳预览帧
4. 调整字幕参数
```

#### 场景3：对比不同场景的字幕效果
```
1. 拖动到暗色场景（如00:30）
2. 调整字幕颜色，确保在暗色背景下可见
3. 拖动到亮色场景（如02:15）
4. 验证字幕在亮色背景下也清晰
```

## 🎨 技术特性

### 实时响应
- 滑块拖动时立即响应
- 自动提取对应时间点的视频帧
- 时间标签实时更新
- 字幕预览自动刷新

### 智能缓存
- 旧的视频帧会自动清理
- 避免占用过多磁盘空间
- 保持系统性能

### 防抖优化
- 字幕预览仍使用500ms防抖
- 快速拖动滑块时不会频繁渲染字幕
- 停止拖动后自动更新字幕效果

### 精确控制
- 滑块范围：0-100%
- 时间精度：秒级
- 支持视频任意长度

## 📝 代码实现细节

### 新增变量
```python
self.current_video_path = None    # 当前视频路径
self.video_duration_ms = 0        # 视频总时长（毫秒）
```

### 新增UI组件
```python
self.timeline_slider              # 时间轴滑块
self.timeline_current_label       # 当前时间标签
self.timeline_duration_label      # 总时长标签
```

### 核心方法

1. **`_on_timeline_changed(value)`**
   - 滑块值改变时触发
   - 计算对应的时间点
   - 更新时间标签
   - 提取新的视频帧

2. **`_update_time_label(time_ms)`**
   - 更新时间标签显示
   - 格式化时间为 HH:MM:SS

3. **`_extract_frame_at_time(time_ms)`**
   - 提取指定时间点的视频帧
   - 使用FFmpeg的 `-ss` 参数精确定位
   - 自动清理旧帧文件
   - 更新预览显示
   - 触发字幕预览更新

### FFmpeg命令
```python
cmd = [
    '-y',
    '-ss', str(seek_time),  # 精确定位到指定时间（秒）
    '-i', video_path,
    '-vframes', '1',        # 只提取一帧
    '-q:v', '2',           # 高质量
    frame_path
]
```

## 🔄 工作流程

```
1. 用户选择视频
   ↓
2. 获取视频时长 → 显示在右侧标签
   ↓
3. 启用时间轴滑块，默认50%
   ↓
4. 提取中间帧 → 显示预览
   ↓
5. 用户拖动滑块
   ↓
6. 计算时间位置 → 更新左侧标签
   ↓
7. 提取新的视频帧
   ↓
8. 显示新帧 → 更新字幕预览
   ↓
9. 用户继续拖动或调整字幕参数...
```

## ⚙️ 时间计算公式

### 百分比 → 毫秒
```python
current_time_ms = int(video_duration_ms * slider_value / 100)
```

### 毫秒 → 时:分:秒
```python
seconds = time_ms / 1000
hours = int(seconds // 3600)
minutes = int((seconds % 3600) // 60)
secs = int(seconds % 60)
time_str = f"{hours:02d}:{minutes:02d}:{secs:02d}"
```

## 📊 性能优化

### 帧提取优化
- 使用FFmpeg的 `-ss` 参数在解码前定位
- 比逐帧扫描快得多
- 对长视频也能快速响应

### 内存管理
- 每次只保留一个视频帧文件
- 旧帧自动删除
- 避免临时文件堆积

### UI响应
- 时间标签立即更新
- 帧提取在后台进行
- 不阻塞UI线程

## 🎯 使用技巧

### 1. 选择代表性帧
- 如果视频包含字幕场景和非字幕场景，选择有内容的地方
- 选择背景对比度高的位置测试字幕可见性
- 避免选择全黑或全白的帧

### 2. 快速定位
- 对于2分钟的视频，每10%约等于12秒
- 可以先大致拖动到目标区域，再微调
- 观察时间标签辅助定位

### 3. 多场景测试
- 选择3-5个不同的时间点
- 确保字幕在各种场景下都清晰可见
- 特别注意明暗对比

## ⚠️ 注意事项

1. **拖动速度**
   - 快速拖动时，每个位置都会提取帧
   - 如果感觉慢，可以直接点击目标位置
   - 等待帧提取完成后再调整字幕参数

2. **时间精度**
   - 时间精度为秒级
   - 对于短视频（<1分钟），可能不够精确
   - 长视频定位非常方便

3. **视频格式**
   - 支持所有FFmpeg支持的格式
   - 某些格式的定位可能稍慢
   - MP4格式定位最快

4. **初始状态**
   - 未选择视频时，滑块是禁用的
   - 选择视频后自动启用
   - 默认位置在50%（中间）

## 🐛 故障排除

### 问题1：滑块拖不动
**原因**：未选择视频文件  
**解决**：先点击"选择视频文件"

### 问题2：拖动后没反应
**原因**：FFmpeg正在处理中  
**解决**：等待几秒，或检查FFmpeg是否正确安装

### 问题3：时间显示不准确
**原因**：视频时长获取错误  
**解决**：尝试重新选择视频文件

### 问题4：预览帧很模糊
**原因**：视频本身分辨率低  
**解决**：这是正常的，不影响最终输出质量

## 📚 修改文件清单

### 修改的文件

1. **`videotrans/ui/vasrt.py`**
   - 新增导入：`QSlider`
   - 新增变量：`current_video_path`, `video_duration_ms`
   - 新增UI组件：时间轴滑块和标签
   - 新增方法：
     * `_on_timeline_changed()`
     * `_update_time_label()`
     * `_extract_frame_at_time()`

2. **`videotrans/winform/fn_vas.py`**
   - 修改 `extract_video_frame()` 函数
   - 添加时间轴初始化逻辑
   - 添加时长标签更新

## 🎉 功能对比

### 之前
- ✅ 自动提取视频中间帧
- ❌ 无法选择其他时间点
- ❌ 不知道视频总时长
- ❌ 无法查看视频其他部分

### 现在
- ✅ 自动提取视频中间帧
- ✅ **可以自由选择任意时间点**
- ✅ **显示视频总时长**
- ✅ **实时拖动预览**
- ✅ **时间标签显示**
- ✅ **全视频范围预览**

## 🚀 下一步建议

### 可能的改进
1. 添加"跳转到开头"和"跳转到结尾"快捷按钮
2. 支持输入具体时间跳转
3. 添加"上一帧/下一帧"按钮精确控制
4. 支持标记常用时间点
5. 显示视频缩略图时间轴

## ✅ 测试检查清单

- [ ] 选择不同长度的视频（1分钟、5分钟、30分钟）
- [ ] 拖动滑块到不同位置（0%, 25%, 50%, 75%, 100%）
- [ ] 验证时间标签显示正确
- [ ] 验证提取的帧对应正确的时间点
- [ ] 快速拖动滑块，检查性能
- [ ] 拖动后调整字幕参数，验证预览更新
- [ ] 测试不同视频格式（mp4, avi, mkv等）

---

**更新日期**: 2025-10-10  
**版本**: 1.1  
**状态**: ✅ 已完成  
**开发者**: AI Assistant

享受全新的时间轴控制功能！🎬✨

